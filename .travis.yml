language: python
python:
  - "3.6"

cache:
  directories:
  - node_modules

before_install:
- wget -qO- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash
- nvm install 8
- node --version

before_script: 
  - pip install awscli
  - pip install aws-sam-cli
  - aws configure set region us-east-1
  - npm run copy-package
  - cd aws-api-gateway-developer-portal
  - npm run install
  - npm run package
  - npm run deploy
  - cd ..

script:
  #- cd aws-api-gateway-developer-portal
  - node ./scripts/getStackFeatures dev-portal #creates .env
  #- cp ./.env ../
  #- cd ..
  - wget -O releases.json https://api.github.com/repos/phillyfan1138/option_price_faas/releases/latest
  - echo "REACT_APP_TAG=$(node ./scripts/outputTag)" >> .env # creates tag for the main site to know which docs to grab
  - echo "SKIP_PREFLIGHT_CHECK=true" >> .env # skips check for module interactions
  - npm install
  - npm test -- --coverage
  - npm run build
  - wget https://github.com/phillyfan1138/fang_oost_cal_charts/raw/master/docs/OptionCalculation.pdf;
  - wget https://github.com/phillyfan1138/fang_oost_cal_charts/raw/master/docs/OptionCalibration.pdf;
  - cd ..

after_success:
  - bash <(curl -s https://codecov.io/bash)

deploy:
  - provider: pages
    skip_cleanup: true
    github_token: $GITHUB_TOKEN
    local_dir: build
    on:
      repo: realoptions/main_site
      branch: master
